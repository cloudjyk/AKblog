<!-- extend base layout -->
{% extends "base.html" %}
{% block content %}

    <article class="post">
        <div class="row avatar_crop">
            <div class="col-lg-1"></div>
            <div class="col-lg-10">
                <form id="avatar_form" class="form-horizontal" action="" method="post" name="post"
                      enctype="multipart/form-data">
                    {% csrf_token %}
                    <!--操作区域-->
                    <div class="avatar-wrapper" id="avatar-wrapper">
                        <img src="blob:http://yshblog.com/bd753fce-5b29-4ed6-8ea4-aaf8434131d3" class="cropper-hidden">
                        <div class="cropper-container cropper-bg" style="width: 778px; height: 370px;">
                            <div class="cropper-wrap-box">
                                <div class="cropper-canvas" style="width: 370px; height: 370px; left: 204px; top: 0px;">
                                    <img src="blob:http://yshblog.com/bd753fce-5b29-4ed6-8ea4-aaf8434131d3"
                                         style="width: 370px; height: 370px; margin-left: 0px; margin-top: 0px; transform: none;">
                                </div>
                            </div>
                            <div class="cropper-drag-box cropper-modal cropper-move"></div>
                            <div class="cropper-crop-box" style="width: 370px; height: 370px; left: 204px; top: 0px;">
                                <span class="cropper-view-box"><img
                                        src="blob:http://yshblog.com/bd753fce-5b29-4ed6-8ea4-aaf8434131d3"
                                        style="width: 370px; height: 370px; margin-left: 0px; margin-top: 0px; transform: none;"></span><span
                                    class="cropper-dashed dashed-h"></span><span class="cropper-dashed dashed-v"></span><span
                                    class="cropper-center"></span><span class="cropper-face cropper-move"></span><span
                                    class="cropper-line line-e" data-action="e"></span><span class="cropper-line line-n"
                                                                                             data-action="n"></span><span
                                    class="cropper-line line-w" data-action="w"></span><span class="cropper-line line-s"
                                                                                             data-action="s"></span><span
                                    class="cropper-point point-e" data-action="e"></span><span
                                    class="cropper-point point-n" data-action="n"></span><span
                                    class="cropper-point point-w" data-action="w"></span><span
                                    class="cropper-point point-s" data-action="s"></span><span
                                    class="cropper-point point-ne" data-action="ne"></span><span
                                    class="cropper-point point-nw" data-action="nw"></span><span
                                    class="cropper-point point-sw" data-action="sw"></span><span
                                    class="cropper-point point-se" data-action="se"></span></div>
                        </div>
                    </div>
                    <!--相关数据-->
                    <div>
                        <input type="hidden" id="avatar_x" name="avatar_x" value="0">
                        <input type="hidden" id="avatar_y" name="avatar_y" value="0">
                        <input type="hidden" id="avatar_width" name="avatar_width" value="180.00000000000003">
                        <input type="hidden" id="avatar_height" name="avatar_height" value="180.00000000000003">
                        <input type="hidden" id="avatar_online" name="avatar_online" value="">
                    </div>
                    <!--按钮组-->
                    <div class="avatar-btns" style="margin-top: 0.5em;">
                        <div class="btn-group">
                            <label class="btn btn-primary" for="avatar-input">上传本地图片</label>
                            <input style="display:none" type="file" class="avatar-input" id="avatar-input"
                                   name="avatar_file" accept=".jpg,.jpeg,.png">
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" id="zoom-in" title="放大">
                                <span class="glyphicon glyphicon-zoom-in"></span>
                            </button>

                            <button type="button" class="btn btn-primary" id="zoom-out" title="缩小">
                                <span class="glyphicon glyphicon-zoom-out"></span>
                            </button>

                            <button type="button" class="btn btn-primary" id="reset" title="复位">
                                <span class="glyphicon glyphicon-refresh"></span>
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <br/>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-lg-2 control-label">username:&nbsp;</label>
                            <div class="col-lg-10">
                                <input class="form-control" tabindex="1" id="username" name="username"
                                       size="80" type="text"
                                       value="{{ request.user.username }}">
                                {% for error in form.errors.username %}
                                    <span class="help-inline">[{{ error }}]</span><br>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-lg-2 control-label">about_me:&nbsp;</label>
                            <div class="col-lg-10">
                                <input class="form-control" tabindex="1" id="about_me" name="about_me"
                                       size="80" type="text"
                                       value="{{ request.user.about_me }}">
                                {% for error in form.errors.about_me %}
                                    <span class="help-inline">[{{ error }}]</span><br>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <div class="avatar-preview" style="width: 94px; height: 94px;"><img
                                src=""
                                style="display: block; width: 94px; height: 94px; min-width: 0px !important; min-height: 0px !important; max-width: none !important; max-height: none !important; margin-left: 0px; margin-top: 0px; transform: none;">
                        </div>
                    </div>
                    <div class="col-lg-1"></div>
                    <div>
                    <div>
                        <div class="col-lg-6">
                            <button class="btn btn-success btn-large btn-block" type="submit" value="Save changes!">
                                Save
                                changes!
                            </button>
                        </div>
                        <div class="col-lg-6">
                            <button class="btn btn-danger btn-large btn-block" type="reset" value="Reset">Reset
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-lg-1"></div>
        </div>
    </article>

    <script type="text/javascript">
        $(function () {
            //初始化裁剪器
            var image = $('#avatar-wrapper img');
            image.cropper({
                checkImageOrigin: true, //检查图片来源
                dragMode: 'move',   //图片可移动
                restore: false,      //窗体调整大小之后不自动恢复裁剪区域
                zoomOnWheel: false, //不允许通过鼠标滚轮缩放
                zoomOnTouch: false, //不允许通过触摸缩放
                aspectRatio: 1 / 1, //裁剪比例
                autoCropArea: 0.5,  //裁剪背景透明度
                autoCropArea: 1,    //自动裁剪的比例
                preview: $(".avatar-preview").selector, //文本的jQuery选择表达式，一个div
                crop: function (e) {
                    $('#avatar_x').val(e.x);
                    $('#avatar_y').val(e.y);
                    $('#avatar_width').val(e.width);
                    $('#avatar_height').val(e.height);
                },
            });

            //选择图片
            function choose_local_img() {
                var URL = window.URL || window.webkitURL;
                if (URL) {
                    var files = this.files;
                    if (files && files.length) {
                        var file = files[0];
                        if (/^image\/\w+$/.test(file.type)) {
                            var blobURL = URL.createObjectURL(file);
                            image.cropper('reset').cropper('replace', blobURL);
                            $('.avatar_crop .disabled').removeClass('disabled');
                            normal_tip('本地图片：可调整到最佳状态再上传');

                            $("#avatar_online").val(''); //去掉在线图片数据
                        } else {
                            error_tip('请选择一张图片');
                        }
                    }
                }
            }

            $("#avatar-input").bind('change', choose_local_img); //绑定事件

            //缩放按钮
            var zoom = 1;
            $("#zoom-in").click(function () {
                if (zoom < 1.5) {
                    zoom += 0.1;
                    image.cropper("zoom", 0.1);
                }
            });
            $("#zoom-out").click(function () {
                if (zoom > 0.5) {
                    zoom -= 0.1;
                    image.cropper("zoom", -0.1);
                }
            });

            //复位按钮
            $('#reset').click(function () {
                image.cropper("reset");
                zoom = 1;
            });

            //csrf处理
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        var csrftoken = $.cookie('csrftoken');
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            //上传头像
            $("#avatar-upload").click(function () {
                if ($('#avatar-wrapper img').attr('src') == '') {
                    error_tip('亲~ 你是不是忘记选择图片了');
                    return false;
                }

                normal_tip("上传中，请稍等一下...");
                var formData = new FormData($("#avatar_form")[0]);
                $.ajax({
                    url: "/user/user_avatar_upload",
                    type: 'POST',
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data['success']) {
                            normal_tip("上传头像成功");
                            $('.navbar-avatar').attr('src', '/' + data['avatar_url']); //更新头像
                        } else {
                            error_tip("提交失败，请重试！");
                        }
                    },
                    error: function (err) {
                        error_tip("提交失败，请重试！" + err);
                    }
                });
                return false;
            });

            //提示
            function error_tip(text) {
                $('#tip-text').removeClass();
                $('#tip-text').addClass('alert alert-danger');
                $('#tip-text').text(text);
            }

            function normal_tip(text) {
                $('#tip-text').removeClass();
                $('#tip-text').addClass('alert alert-info');
                $('#tip-text').text(text);
            }
        });
    </script>

{% endblock %}

